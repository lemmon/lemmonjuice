<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Game of Life</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/abrusco@0.6.4/css/abrusco.min.css">
</head>
<body class="col justify-center items-center">

  <div class="p05 code f4 lh2">
    <div class="p05" id="board" style="white-space: pre;"></div>
    <div class="p05" id="stats"></div>
  </div>

  <script>
  const board = document.getElementById('board')
  const stats = document.getElementById('stats')
  const state = {
    generation: 0,
    width: 100,
    height: 80,
    perf: [],
  }
  state.board = generateRandom(state.width, state.height)

  function generateRandom(width, height) {
    const board = new Array(height)
    for (let y = 0; y < height; y++) {
      board[y] = new Array(width)
      for (let x = 0; x < width; x++) {
        board[y][x] = Math.round(Math.random())
      }
    }
    return board
  }

  function drawBoard(board, data) {
    const height = data.length
    for (let y = 0; y < height; y++) {
      const row = board.children[y] || board.appendChild(createRow())
      row.textContent = data[y].map( cell => cell ? '[]' : '  ' ).join('')
    }
  }

  function createRow() {
    const row = document.createElement('div')
    //row.disabled = true
    return row
  }

  function createCell() {
    const cell = document.createElement('span')
    cell.innerHTML = '[X]'
    return cell
  }

  function nextGeneration(data) {
    const height = data.length
    const res = new Array(height)
    for (let y = 0; y < height; y++) {
      const width = data[y].length
      res[y] = new Array(width)
      for (let x = 0; x < width; x++) {
        const n = countNeighbors(data, x, y)
        res[y][x] = data[y][x]
          ? n === 2 && 1 || n === 3 && 1 || 0
          : n === 3 && 1 || 0
      }
    }
    return res
  }

  function countNeighbors(data, x, y) {
    return 0
      + (data[y][x - 1] || 0)
      + (data[y][x + 1] || 0)
      + (data[y - 1] ? ((data[y - 1][x]) + (data[y - 1][x - 1] || 0) + (data[y - 1][x + 1] || 0)) : 0)
      + (data[y + 1] ? ((data[y + 1][x]) + (data[y + 1][x - 1] || 0) + (data[y + 1][x + 1] || 0)) : 0)
  }

  drawBoard(board, state.board)

  setInterval(() => {
    const t0 = Date.now()
    state.board = nextGeneration(state.board)
    state.generation++
    /*
    */
    drawBoard(board, state.board)
    state.perf.push(Date.now() - t0)
    state.perf.splice(0, state.perf.length - 10)
    stats.innerHTML = `<span class="color-black-40">generation:</span> ${state.generation}`
      + ` <span class="color-black-40">(${Math.round(state.perf.reduce((acc, curr) => acc + curr, 0) / state.perf.length)}ms)</span>`
  }, 50)
  </script>

</body>
</html>
